<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>TripMe | Real-Time Flights</title>
    <style>
        :root { --primary: #0052cc; --accent: #ff6d38; --bg: #f4f7fa; --select-blue: #00a8ff; }
        * { box-sizing: border-box; margin: 0; padding: 0; }
        
        body { font-family: 'Segoe UI', sans-serif; background: var(--bg); display: flex; height: 100vh; overflow: hidden; }

        .left-side { flex: 3; display: flex; flex-direction: column; overflow: hidden; }
        .header-stripe { background: var(--primary); color: white; padding: 15px 40px; font-size: 1.2rem; font-weight: bold; }
        .main-container { padding: 30px 40px; overflow-y: auto; flex: 1; }

        /* Search Card Rows */
        .search-card { background: white; padding: 25px; border-radius: 12px; box-shadow: 0 4px 15px rgba(0,0,0,0.05); margin-bottom: 25px; position: relative; }
        
        .input-row { display: grid; gap: 20px; margin-bottom: 20px; position: relative; align-items: end; }
        /* Row 1: Space for Swap Button */
        .row-1 { grid-template-columns: 1fr 1fr; gap: 80px; } 
        .row-2, .row-3 { grid-template-columns: 1fr 1fr; } 

        label { font-size: 0.7rem; font-weight: 700; color: #666; margin-bottom: 6px; display: block; text-transform: uppercase; }
        
        input { padding: 12px; border: 1px solid #ddd; border-radius: 8px; width: 100%; font-size: 1rem; background: white; }
        input:focus { outline: none; border-color: var(--primary); }

        .field-wrapper { position: relative; }
        .suggestions { 
            position: absolute; width: 100%; background: white; border: 1px solid #ddd; 
            border-radius: 0 0 8px 8px; z-index: 100; max-height: 180px; overflow-y: auto; display: none;
            box-shadow: 0 10px 15px rgba(0,0,0,0.1);
        }
        .suggestion-item { padding: 10px; cursor: pointer; border-bottom: 1px solid #eee; font-size: 0.9rem; }
        .suggestion-item:hover { background: #f0f7ff; }

        .swap-btn {
            position: absolute; left: 50%; top: 58%; transform: translate(-50%, -50%);
            width: 40px; height: 40px; background: white; border: 2px solid #eee;
            border-radius: 50%; cursor: pointer; z-index: 10; font-weight: bold; display: flex; align-items: center; justify-content: center;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1); transition: 0.2s;
        }
        .swap-btn:hover { border-color: var(--primary); color: var(--primary); }

        /* Price Range Slider */
        .slider-section { margin-bottom: 25px; background: #f1f5f9; padding: 15px; border-radius: 10px; }
        .slider-header { display: flex; justify-content: space-between; margin-bottom: 8px; }
        input[type="range"] { width: 100%; cursor: pointer; accent-color: var(--primary); }

        .search-btn { background: var(--accent); color: white; border: none; padding: 16px; border-radius: 8px; font-weight: bold; cursor: pointer; width: 100%; font-size: 1.1rem; }

        /* Flight Tickets */
        .ticket { background: white; border-radius: 12px; margin-bottom: 15px; display: flex; border: 1px solid #eee; overflow: hidden; animation: slideIn 0.3s ease-out; }
        @keyframes slideIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        
        .ticket-info { flex: 3; padding: 20px; display: flex; justify-content: space-around; align-items: center; }
        .price-zone { flex: 1.2; padding: 20px; background: #fcfcfc; border-left: 1px dashed #ddd; text-align: center; display: flex; flex-direction: column; justify-content: center; gap: 10px; }
        .price-val { font-size: 1.5rem; font-weight: 800; color: #28a745; }

        /* Big Light Blue Select Button */
        .select-btn { 
            background: var(--select-blue); color: white; border: none; 
            padding: 12px 24px; border-radius: 8px; font-weight: bold; 
            cursor: pointer; font-size: 1rem; width: 100%; transition: 0.2s;
        }
        .select-btn:hover { background: #0092dd; transform: scale(1.02); }

        /* AI Sidebar */
        .ai-sidebar { flex: 1; max-width: 350px; background: white; border-left: 1px solid #ddd; display: flex; flex-direction: column; }
        .ai-header { background: #003d99; color: white; padding: 20px; font-weight: bold; }
        .ai-body { padding: 15px; flex: 1; display: flex; flex-direction: column; gap: 10px; overflow: hidden; }
        .ai-chat-box { flex: 1; background: #f9f9f9; border-radius: 8px; padding: 10px; overflow-y: auto; display: flex; flex-direction: column; gap: 8px; font-size: 0.9rem; }
        .msg { padding: 8px 12px; border-radius: 8px; max-width: 85%; line-height: 1.4; }
        .msg-ai { background: #e9e9eb; align-self: flex-start; }
        .msg-user { background: var(--primary); color: white; align-self: flex-end; }
    </style>
</head>
<body>

    <div class="left-side">
        <div class="header-stripe">TripMe</div>
        <main class="main-container">
            <div class="search-card">
                <div class="input-row row-1">
                    <div class="field-wrapper">
                        <label>From City</label>
                        <input type="text" id="fromInput" autocomplete="off" data-code="BOM" value="Mumbai (BOM)">
                        <div id="fromList" class="suggestions"></div>
                    </div>
                    <button class="swap-btn" onclick="swap()">‚áÑ</button>
                    <div class="field-wrapper">
                        <label>To City</label>
                        <input type="text" id="toInput" autocomplete="off" data-code="DXB" value="Dubai (DXB)">
                        <div id="toList" class="suggestions"></div>
                    </div>
                </div>

                <div class="input-row row-2">
                    <div><label>Departure Date</label><input type="date" id="travelDate"></div>
                    <div><label>Total Travelers</label><input type="text" id="totalPax" value="1" readonly style="background:#f8f9fa;"></div>
                </div>

                <div class="input-row row-3">
                    <div><label>No. of Adults</label><input type="number" id="adults" value="1" min="1" max="9" oninput="updatePax()"></div>
                    <div><label>No. of Children</label><input type="number" id="children" value="0" min="0" max="9" oninput="updatePax()"></div>
                </div>

                <div class="slider-section">
                    <div class="slider-header">
                        <label>Max Budget</label>
                        <span id="priceLabel" style="font-weight:bold; color:var(--primary)">‚Çπ75,000</span>
                    </div>
                    <input type="range" id="priceRange" min="5000" max="300000" step="5000" value="75000" oninput="updatePriceLabel(this.value)">
                </div>
                
                <button class="search-btn" onclick="fetchFlights()">SEARCH LIVE TICKETS</button>
            </div>
            <div id="results"></div>
        </main>
    </div>

    <aside class="ai-sidebar">
        <div class="ai-header">ü§ñ TripMe AI Assistant</div>
        <div class="ai-body">
            <div class="ai-chat-box" id="chatBox"></div>
            <div style="display:flex; gap:8px">
                <input type="text" id="aiInput" style="flex:1; padding:10px; border-radius:8px; border:1px solid #ccc" placeholder="Ask AI..." onkeydown="if(event.key==='Enter')sendMessage()">
                <button onclick="sendMessage()" style="padding:10px; background:#28a745; color:white; border:none; border-radius:8px; cursor:pointer">Send</button>
            </div>
        </div>
    </aside>

    <script>
        const airlineLinks = {
            "AI": "https://www.airindia.in", "6E": "https://www.goindigo.in",
            "UK": "https://www.airvistara.com", "QP": "https://www.akasaair.com",
            "SG": "https://www.spicejet.com", "EK": "https://www.emirates.com"
        };

        const airports = [
            { city: "Mumbai", iata: "BOM" }, { city: "New Delhi", iata: "DEL" },
            { city: "Bengaluru", iata: "BLR" }, { city: "Hyderabad", iata: "HYD" },
            { city: "London", iata: "LHR" }, { city: "Dubai", iata: "DXB" }
        ];

        function setupSearch(inputId, listId) {
            const input = document.getElementById(inputId);
            const list = document.getElementById(listId);
            input.addEventListener('focus', () => {
                list.innerHTML = airports.map(a => `<div class="suggestion-item" onclick="selectItem('${inputId}','${listId}','${a.city}','${a.iata}')"><strong>${a.iata}</strong> - ${a.city}</div>`).join('');
                list.style.display = 'block';
            });
        }
        function selectItem(inp, lst, city, code) {
            const el = document.getElementById(inp);
            el.value = `${city} (${code})`; el.setAttribute('data-code', code);
            document.getElementById(lst).style.display = 'none';
        }

        setupSearch('fromInput', 'fromList');
        setupSearch('toInput', 'toList');

        function updatePriceLabel(val) {
            document.getElementById('priceLabel').innerText = `‚Çπ${parseInt(val).toLocaleString()}`;
        }

        function updatePax() {
            const a = parseInt(document.getElementById('adults').value) || 0;
            const c = parseInt(document.getElementById('children').value) || 0;
            document.getElementById('totalPax').value = (a + c) + " Traveler(s)";
        }

        function swap() {
            const f = document.getElementById('fromInput'), t = document.getElementById('toInput');
            const fC = f.getAttribute('data-code'), tC = t.getAttribute('data-code');
            const fV = f.value, tV = t.value;
            f.value = tV; f.setAttribute('data-code', tC);
            t.value = fV; t.setAttribute('data-code', fC);
        }

        async function fetchFlights() {
            const container = document.getElementById('results');
            container.innerHTML = '<h4 style="text-align:center;">üîç Searching Real-Time Fares...</h4>';
            const origin = document.getElementById('fromInput').getAttribute('data-code');
            const dest = document.getElementById('toInput').getAttribute('data-code');
            const date = document.getElementById('travelDate').value;
            const maxPrice = document.getElementById('priceRange').value;

            try {
                const res = await fetch(`http://localhost:5000/api/flights?origin=${origin}&destination=${dest}&date=${date}`);
                const data = await res.json();
                
                if (!data.data || data.data.length === 0) {
                    container.innerHTML = '<div style="text-align:center; padding:20px;">No flights found.</div>';
                    return;
                }

                container.innerHTML = '';
                const seenPrices = new Set();
                
                data.data.filter(f => (f.price.total * 90) <= maxPrice).forEach(f => {
                    const price = Math.floor(f.price.total * 90);
                    // Filter out duplicate price points (code-shares)
                    if (seenPrices.has(price)) return;
                    seenPrices.add(price);

                    const code = f.itineraries[0].segments[0].carrierCode;
                    const url = airlineLinks[code] || `https://www.google.com/search?q=${code}+airline`;
                    const time = f.itineraries[0].segments[0].departure.at.split('T')[1].substring(0,5);

                    container.innerHTML += `
                        <div class="ticket">
                            <div class="ticket-info">
                                <div><strong>${code}</strong></div>
                                <div><h4>${time}</h4><p>${origin}</p></div>
                                <div style="color:var(--primary); font-size:1.5rem">‚úà</div>
                                <div><h4>Arrival</h4><p>${dest}</p></div>
                            </div>
                            <div class="price-zone">
                                <div class="price-val">‚Çπ${price.toLocaleString()}</div>
                                <button class="select-btn" onclick="window.open('${url}', '_blank')">SELECT</button>
                            </div>
                        </div>`;
                });
            } catch {
                container.innerHTML = '<div style="text-align:center; color:red; padding:20px;">Server Offline. Run "node server.js"</div>';
            }
        }

        // Logic for AI messaging and cleanup
        let messages = [{ role: 'ai', content: 'Hello! Ready to plan your next trip?' }];
        function renderMessages() {
            const box = document.getElementById('chatBox');
            box.innerHTML = messages.map(m => `<div class="msg ${m.role==='ai'?'msg-ai':'msg-user'}"><strong>${m.role==='ai'?'AI: ':'You: '}</strong>${m.content}</div>`).join('');
            box.scrollTop = box.scrollHeight;
        }
        async function sendMessage() {
            const input = document.getElementById('aiInput');
            const content = input.value.trim();
            if(!content) return;
            messages.push({role:'user', content});
            renderMessages();
            input.value = '';
            try {
                const res = await fetch('http://localhost:5000/api/chat', { method: 'POST', headers: {'Content-Type': 'application/json'}, body: JSON.stringify({ prompt: content }) });
                const data = await res.json();
                messages.push({role:'ai', content: data.reply});
                renderMessages();
            } catch {
                messages.push({role:'ai', content: 'Hey. The server is under repairs. Please Try Again after maintainence.'});
                renderMessages();
            }
        }

        window.onload = () => {
            const d = new Date(); d.setDate(d.getDate() + 7);
            document.getElementById('travelDate').value = d.toISOString().split('T')[0];
            updatePax();
            renderMessages();
        };
        document.addEventListener('click', (e) => {
            if (!e.target.closest('.field-wrapper')) document.querySelectorAll('.suggestions').forEach(l => l.style.display = 'none');
        });
    </script>
</body>
</html>